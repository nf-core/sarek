/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
        ext.when   = When to run the module.
----------------------------------------------------------------------------------------
*/

// MAPPING WITH PARABRICKS

process {
    withName: 'PARABRICKS_FQ2BAM' {
        ext.args   = { [
            // Using specific read group tags for mutect compability
            "--read-group-id-prefix ${meta.sample_lane_id}",
            "--read-group-sm ${meta.patient}_${meta.sample}",
            "--read-group-lb ${meta.sample}",
            "--read-group-pl ${params.seq_platform}",
            // Using -B 3 for tumor samples
            meta.status == 1 ? "--bwa-options='-K 100000000 -Y -B 3'" : "--bwa-options='-K 100000000 -Y'",
        ].join(' ').trim() }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/preprocessing/parabricks/${meta.id}/" },
            pattern: "*{cram,crai}",
            saveAs: { params.save_mapped ? it : null }
        ]
    }

    withName: 'NFCORE_SAREK:SAREK:FASTQ_PREPROCESS_PARABRICKS:CRAM_MERGE_INDEX_SAMTOOLS:MERGE_CRAM' {
        ext.when         = { meta.num_lanes > 1 }
        publishDir       = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/preprocessing/parabricks/${meta.id}/" },
            pattern: "*cram",
            saveAs: { params.save_mapped ? it : null }
        ]
    }

    withName: 'NFCORE_SAREK:SAREK:FASTQ_PREPROCESS_PARABRICKS:CRAM_MERGE_INDEX_SAMTOOLS:INDEX_CRAM' {
        publishDir       = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/preprocessing/parabricks/${meta.id}/" },
            pattern: "*{cram,crai}",
            saveAs: { params.save_mapped ? it : null }
        ]
    }

    withName: 'NFCORE_SAREK:SAREK:FASTQ_PREPROCESS_PARABRICKS:CRAM_TO_BAM' {
        //ext.when   = { params.save_output_as_bam }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/preprocessing/parabricks/${meta.id}/" },
            pattern: "*{bam,bam.bai}",
            saveAs: { params.save_output_as_bam ? it : null }
        ]
    }
}
