/*
========================================================================================
    Custom VEP Plugin Configuration
========================================================================================
    Configuration file to add extensive VEP plugins matching the other pipeline's setup.
    Usage: nextflow run nf-core/sarek -c conf/vep_plugins.config
========================================================================================
*/

params {
    // Override VEP custom args to add additional flags
    vep_custom_args = "--everything --force_overwrite --port 3337 --buffer_size 500000 --xref_refseq --verbose --offline --format vcf"

    // Set output format to tab (change to "vcf" if you prefer VCF output)
    vep_out_format = "tab"

    // Enable all dbNSFP fields
    vep_dbnsfp = true
    dbnsfp_fields = "ALL"

    // Plugin resource files - set these to your actual file paths
    // Example paths - update these to match your resource locations
    vep_plugin_dir = "/path/to/vep/Plugin_resources"  // Base directory for plugin resources

    // MPC Plugin
    mpc_file = "${params.vep_plugin_dir}/MPC/fordist_constraint_official_mpc_values.txt.gz"

    // Condel Plugin
    condel_config = "${params.vep_plugin_dir}/Condel/config"

    // ExAC Plugin
    exac_file = "${params.vep_plugin_dir}/ExAC/ExAC.r0.3.1.sites.vep.vcf.gz"

    // ExACpLI Plugin
    exacpli_file = "${params.vep_plugin_dir}/ExACpLI/ExACpLI_values.txt"

    // gnomADc Plugin
    gnomadcov_dir = "${params.vep_plugin_dir}/gnomADc/r2.0.2/coverage/exomes/"

    // LoFtool Plugin
    loftool_file = "${params.vep_plugin_dir}/LoFtool/LoFtool_scores.txt"

    // Mastermind Plugin
    mastermind_file = "${params.vep_plugin_dir}/Mastermind/mastermind_cited_variants_reference-2020.04.02-grch37.vcf.gz"

    // REVEL Plugin
    revel_file = "${params.vep_plugin_dir}/REVEL/new_tabbed_revel.tsv.gz"

    // Phenotypes Plugin
    phenotypes_file = "${params.vep_plugin_dir}/Phenotypes/Phenotypes.pm_homo_sapiens_98_GRCh37.gvf.gz"

    // dbNSFP Plugin (update version as needed)
    dbnsfp = "${params.vep_plugin_dir}/dbNSFP/v3.5a/dbNSFP3.5a_hg19.gz"
    dbnsfp_tbi = "${params.vep_plugin_dir}/dbNSFP/v3.5a/dbNSFP3.5a_hg19.gz.tbi"
}

process {
    withName: 'ENSEMBLVEP_VEP' {
        // Add all plugin configurations to ext.args
        ext.args = { [
            // MPC Plugin
            params.mpc_file ? "--plugin MPC,${params.mpc_file}" : '',

            // Carol Plugin (no file needed)
            "--plugin Carol",

            // Condel Plugin
            params.condel_config ? "--plugin Condel,${params.condel_config},b" : '',

            // ExAC Plugin
            params.exac_file ? "--plugin ExAC,${params.exac_file}" : '',

            // ExACpLI Plugin
            params.exacpli_file ? "--plugin ExACpLI,${params.exacpli_file}" : '',

            // gnomADc Plugin
            params.gnomadcov_dir ? "--plugin gnomADc,${params.gnomadcov_dir}" : '',

            // LoFtool Plugin
            params.loftool_file ? "--plugin LoFtool,${params.loftool_file}" : '',

            // Mastermind Plugin
            params.mastermind_file ? "--plugin Mastermind,${params.mastermind_file}" : '',

            // REVEL Plugin
            params.revel_file ? "--plugin REVEL,${params.revel_file}" : '',

            // Phenotypes Plugin
            params.phenotypes_file ? "--plugin Phenotypes,file=${params.phenotypes_file},include_types=Gene" : '',

            // dbNSFP Plugin (with ALL fields)
            (params.vep_dbnsfp && params.dbnsfp) ? "--plugin dbNSFP,${params.dbnsfp.split("/")[-1]},${params.dbnsfp_fields}" : '',

            // Output format
            params.vep_out_format ? "--${params.vep_out_format}" : '--vcf',

            // Custom args
            params.vep_custom_args ?: ''
        ].join(' ').trim() }
    }
}