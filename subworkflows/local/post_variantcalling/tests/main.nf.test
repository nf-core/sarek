nextflow_workflow {

    name "Test Subworkflow POST_VARIANTCALLING"
    script "../main.nf"
    workflow "POST_VARIANTCALLING"
    config "./nextflow.config"

    tag "subworkflows"
    tag "subworkflows_local"
    tag "post_variantcalling"

    test("POST_VARIANTCALLING - normalization only") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup
                tools              = 'strelka'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = true
                varlociraptor_chunk_size = 15
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - concatenation only") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup
                tools              = 'haplotypecaller,strelka'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'haplotypecaller'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)],
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = true
                normalize_vcfs     = false
                varlociraptor_chunk_size = 15
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - normalization and concatenation") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup
                tools              = 'haplotypecaller,strelka'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'haplotypecaller'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)],
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = true
                normalize_vcfs     = true
                varlociraptor_chunk_size = 15
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - no processing") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup
                tools              = 'strelka'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 15
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.vcfs.size() == 0 }
            )
        }
    }

    test("POST_VARIANTCALLING - normalization only - stub") {

        options "-stub"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup
                tools              = 'strelka'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = true
                varlociraptor_chunk_size = 15
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - concatenation only - stub") {

        options "-stub"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup
                tools              = 'haplotypecaller,strelka'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'haplotypecaller'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)],
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = true
                normalize_vcfs     = false
                varlociraptor_chunk_size = 15
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - varlociraptor germline") {

        tag "varlociraptor"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup with real test data
                tools              = 'varlociraptor'
                cram_germline      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test.paired_end.recalibrated.sorted.cram', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test.paired_end.recalibrated.sorted.cram.crai', checkIfExists: true)]
                )
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 2
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - varlociraptor germline - stub") {

        options "-stub"

        tag "varlociraptor"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Create mock CRAM files for testing
                def mock_cram = file("${workDir}/test.cram")
                def mock_crai = file("${workDir}/test.cram.crai")
                mock_cram.text = "mock cram file"
                mock_crai.text = "mock crai file"

                // Input setup
                tools              = 'varlociraptor'
                cram_germline      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0],
                     mock_cram,
                     mock_crai]
                )
                germline_vcfs      = Channel.of(
                    [[id: 'test_sample', patient: 'test', sample: 'test', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 2
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - varlociraptor tumor-only") {

        tag "varlociraptor"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup with real test data
                tools              = 'varlociraptor'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.empty()
                cram_tumor_only    = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XY', status: 1],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test2.paired_end.recalibrated.sorted.cram', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test2.paired_end.recalibrated.sorted.cram.crai', checkIfExists: true)]
                )
                tumor_only_vcfs    = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XY', status: 1, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 2
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - varlociraptor tumor-only - stub") {

        options "-stub"

        tag "varlociraptor"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Create mock CRAM files for testing
                def mock_cram = file("${workDir}/tumor.cram")
                def mock_crai = file("${workDir}/tumor.cram.crai")
                mock_cram.text = "mock cram file"
                mock_crai.text = "mock crai file"

                // Input setup
                tools              = 'varlociraptor'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.empty()
                cram_tumor_only    = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XY', status: 1],
                     mock_cram,
                     mock_crai]
                )
                tumor_only_vcfs    = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XY', status: 1, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_somatic       = Channel.empty()
                somatic_vcfs       = Channel.empty()
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 2
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - varlociraptor somatic") {

        tag "varlociraptor"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Input setup with real test data
                tools              = 'varlociraptor'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'normal_sample', patient: 'test', sample: 'normal', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XX', status: 1, normal_id: 'normal_sample'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test.paired_end.recalibrated.sorted.cram', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test.paired_end.recalibrated.sorted.cram.crai', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test2.paired_end.recalibrated.sorted.cram', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/cram/test2.paired_end.recalibrated.sorted.cram.crai', checkIfExists: true)]
                )
                somatic_vcfs       = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XX', status: 1, normal_id: 'normal_sample', variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 2
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("POST_VARIANTCALLING - varlociraptor somatic - stub") {

        options "-stub"

        tag "varlociraptor"

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                // Create mock CRAM files for testing
                def mock_normal_cram = file("${workDir}/normal.cram")
                def mock_normal_crai = file("${workDir}/normal.cram.crai")
                def mock_tumor_cram  = file("${workDir}/tumor.cram")
                def mock_tumor_crai  = file("${workDir}/tumor.cram.crai")
                mock_normal_cram.text = "mock normal cram"
                mock_normal_crai.text = "mock normal crai"
                mock_tumor_cram.text  = "mock tumor cram"
                mock_tumor_crai.text  = "mock tumor crai"

                // Input setup
                tools              = 'varlociraptor'
                cram_germline      = Channel.empty()
                germline_vcfs      = Channel.of(
                    [[id: 'normal_sample', patient: 'test', sample: 'normal', sex: 'XX', status: 0, variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                cram_tumor_only    = Channel.empty()
                tumor_only_vcfs    = Channel.empty()
                cram_somatic       = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XX', status: 1, normal_id: 'normal_sample'],
                     mock_normal_cram,
                     mock_normal_crai,
                     mock_tumor_cram,
                     mock_tumor_crai]
                )
                somatic_vcfs       = Channel.of(
                    [[id: 'tumor_sample', patient: 'test', sample: 'tumor', sex: 'XX', status: 1, normal_id: 'normal_sample', variantcaller: 'strelka'],
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz', checkIfExists: true),
                     file(params.modules_testdata_base_path + 'genomics/homo_sapiens/illumina/gatk/haplotypecaller_calls/test2_haplotc.vcf.gz.tbi', checkIfExists: true)]
                )
                fasta              = Channel.of([[id: 'fasta'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta', checkIfExists: true)])
                fai                = Channel.of([[id: 'fai'], file(params.modules_testdata_base_path + 'genomics/homo_sapiens/genome/genome.fasta.fai', checkIfExists: true)])
                concatenate_vcfs   = false
                normalize_vcfs     = false
                varlociraptor_chunk_size = 2
                filter_vcfs        = false

                input[0]  = tools
                input[1]  = cram_germline
                input[2]  = germline_vcfs
                input[3]  = cram_tumor_only
                input[4]  = tumor_only_vcfs
                input[5]  = cram_somatic
                input[6]  = somatic_vcfs
                input[7]  = fasta
                input[8]  = fai
                input[9]  = concatenate_vcfs
                input[10] = normalize_vcfs
                input[11] = varlociraptor_chunk_size
                input[12] = filter_vcfs
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcfs,
                    workflow.out.versions
                ).match() }
            )
        }
    }
}
